<!-- pages/index/index.wxml -->
<view class="swab-container">
  <!-- Top Navigation -->
  <view class="swab-nav">
    <text class="swab-logo">{{uiText.title}}</text>
    <view class="swab-nav-actions">
      <view class="swab-action-btn" bindtap="toggleLanguage">
        {{language === 'en' ? 'EN' : 'ä¸­'}}
      </view>
      <view class="swab-action-btn" bindtap="goToSettings">âš™ï¸</view>
    </view>
  </view>

  <!-- Hero Section -->
  <view class="swab-hero" wx:if="{{!cardData && !loading && !error}}">
    <text class="swab-hero-title">{{uiText.title}}</text>
    <text class="swab-hero-subtitle">{{uiText.subtitle}}</text>
    <view class="swab-hero-icon">ğŸ£</view>
    <view class="swab-flashcard-hero-btn" bindtap="generateJoke">
      <text class="swab-flashcard-icon">ğŸ¯</text>
      <text class="swab-flashcard-text">{{uiText.jokeBtn}}</text>
    </view>
  </view>

  <!-- Quick Actions Section -->
  <view class="swab-quick-actions" wx:if="{{!cardData && !loading && !error}}">
    <view class="action-card" bindtap="goToArticles">
      <view class="action-icon-large">ğŸ“š</view>
      <text class="action-title">{{language === 'en' ? 'Read Articles' : 'ç²¾é€‰æ–‡ç« '}}</text>
      <text class="action-desc">{{language === 'en' ? 'Browse our curated collection of fly fishing guides' : 'æµè§ˆæˆ‘ä»¬ç²¾é€‰çš„é£é’“æŒ‡å—é›†åˆ'}}</text>
      <view class="action-meta">
        <text class="action-count">{{articleCount}} {{language === 'en' ? 'article' : 'ç¯‡æ–‡ç« '}}</text>
        <text class="action-arrow">â†’</text>
      </view>
    </view>

    <view class="action-card action-card-primary" bindtap="scrollToCategories">
      <view class="action-icon-large">âœ¨</view>
      <text class="action-title">{{language === 'en' ? 'Search for Knowledge' : 'æœç´¢çŸ¥è¯†'}}</text>
      <text class="action-desc">{{language === 'en' ? 'Search and explore fly fishing topics' : 'æœç´¢å¹¶æ¢ç´¢é£é’“ä¸»é¢˜'}}</text>
      <view class="action-meta">
        <text class="action-count">{{language === 'en' ? 'Choose category or enter topic' : 'é€‰æ‹©åˆ†ç±»æˆ–è¾“å…¥ä¸»é¢˜'}}</text>
        <text class="action-arrow">â†“</text>
      </view>
    </view>
  </view>

  <!-- Tips Section -->
  <view class="swab-tips-section" wx:if="{{!cardData && !loading && !error}}">
    <view class="tips-header">
      <text class="tips-title">{{language === 'en' ? 'ğŸ’¡ How It Works' : 'ğŸ’¡ ä½¿ç”¨æŒ‡å—'}}</text>
    </view>
    <view class="tips-list">
      <view class="tip-item">
        <view class="tip-number">1</view>
        <view class="tip-content">
          <text class="tip-title">{{language === 'en' ? 'Read Pre-Written Articles' : 'é˜…è¯»ç°æˆæ–‡ç« '}}</text>
          <text class="tip-desc">{{language === 'en' ? 'Tap "Read Articles" to browse our expert-curated guides on casting, tying, biology, and gear.' : 'ç‚¹å‡»"ç²¾é€‰æ–‡ç« "æµè§ˆæˆ‘ä»¬ä¸“å®¶ç­–åˆ’çš„æŠ›æŠ•ã€ç»‘é’©ã€ç”Ÿç‰©å­¦å’Œè£…å¤‡æŒ‡å—ã€‚'}}</text>
        </view>
      </view>
      <view class="tip-item">
        <view class="tip-number">2</view>
        <view class="tip-content">
          <text class="tip-title">{{language === 'en' ? 'Search Any Topic' : 'æœç´¢ä»»æ„ä¸»é¢˜'}}</text>
          <text class="tip-desc">{{language === 'en' ? 'Select a category below or type your own topic to find relevant articles.' : 'åœ¨ä¸‹æ–¹é€‰æ‹©åˆ†ç±»æˆ–è¾“å…¥ä¸»é¢˜æ¥æŸ¥æ‰¾ç›¸å…³æ–‡ç« ã€‚'}}</text>
        </view>
      </view>
      <view class="tip-item">
        <view class="tip-number">3</view>
        <view class="tip-content">
          <text class="tip-title">{{language === 'en' ? 'Learn with Flashcards' : 'ç”¨é—ªå¡å­¦ä¹ '}}</text>
          <text class="tip-desc">{{language === 'en' ? 'Tap the flashcard button while searching to learn fly fishing terminology.' : 'åœ¨æœç´¢è¿‡ç¨‹ä¸­ç‚¹å‡»é—ªå¡æŒ‰é’®å­¦ä¹ é£é’“æœ¯è¯­ã€‚'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Main Content -->
  <view class="swab-content">
    <!-- Article Display -->
    <view class="swab-article" wx:if="{{cardData}}">
      <image class="swab-article-image" src="{{cardData.imageUrl}}" mode="aspectFill"></image>

      <view class="swab-article-body">
        <view class="swab-article-header">
          <view class="swab-tag">{{cardData.category}}</view>
          <view class="swab-copy-btn" bindtap="copyArticle">
            ğŸ“‹ {{uiText.copyArticle}}
          </view>
        </view>

        <text class="swab-article-title">{{cardData.title}}</text>

        <view class="swab-sections">
          <view class="swab-section" wx:for="{{cardData.paragraphs}}" wx:key="index">
            <image class="swab-section-image" src="{{item.imageUrl}}" mode="aspectFill"></image>
            <view class="swab-section-content">
              <text class="swab-section-intro">{{item.intro}}</text>
              <view class="swab-subpoints" wx:if="{{item.subParagraphs && item.subParagraphs.length > 0}}">
                <view class="swab-subpoint" wx:for="{{item.subParagraphs}}" wx:for-item="sub" wx:key="*this">
                  <text class="subpoint-text">{{sub}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- Scroll to Top Button -->
        <view class="swab-scroll-top-container">
          <button class="swab-scroll-top-btn" bindtap="scrollToTop">
            <text class="scroll-icon">â†‘</text>
            <text class="scroll-text">{{language === 'en' ? 'Back to Top' : 'è¿”å›é¡¶éƒ¨'}}</text>
          </button>
        </view>

        <view class="swab-references" wx:if="{{cardData.references && cardData.references.length > 0}}">
          <text class="swab-ref-title">{{language === 'en' ? 'REFERENCES' : 'å‚è€ƒæ¥æº'}}</text>
          <view class="swab-ref-list">
            <view class="swab-ref-item" wx:for="{{cardData.references}}" wx:key="url">
              <view class="swab-ref-content">
                <text class="swab-ref-name">{{item.title}}</text>
                <text class="swab-ref-link">{{item.url}}</text>
              </view>
              <view class="swab-ref-copy" bindtap="copyUrl" data-url="{{item.url}}">
                ğŸ“‹
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- Loading State -->
    <view class="swab-loading" wx:if="{{loading}}">
      <view class="swab-loader-ring"></view>
      <text class="swab-loading-title">{{loadingTitle}}</text>
      <text class="swab-loading-text">{{loadingStep}}</text>
      <text class="swab-loading-detail">{{loadingDetail}}</text>

      <!-- Streaming Progress Display -->
      <view class="swab-streaming-section" wx:if="{{streamingActive && streamingSections.length > 0}}">
        <view class="streaming-sections-container">
          <view
            class="streaming-section-card"
            wx:for="{{streamingSections}}"
            wx:key="index"
          >
            <view class="streaming-section-header">
              <text class="streaming-section-title">{{item.title}}</text>
              <view class="streaming-status">
                <text class="status-dot {{item.completed ? 'completed' : 'streaming'}}"></text>
                <text class="status-text">{{item.completed ? 'Done' : 'Searching...'}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <view class="swab-tip-btn" bindtap="generateJoke">
        <text class="tip-icon">ğŸ£</text>
        <text class="tip-text">{{uiText.jokeBtn}}</text>
      </view>
    </view>

    <!-- Error State -->
    <view class="swab-error" wx:if="{{error}}">
      <text class="error-icon">âš ï¸</text>
      <text class="error-text">{{error}}</text>
    </view>
  </view>

  <!-- Section Divider -->
  <view class="swab-section-divider" wx:if="{{!loading && !cardData && !error}}">
    <view class="divider-line"></view>
  </view>

  <!-- Category Selection -->
  <view class="swab-categories" wx:if="{{!loading}}">
    <view class="swab-categories-header">
      <text class="swab-categories-title">{{language === 'en' ? 'âœ¨ Search for Articles' : 'âœ¨ æœç´¢æ–‡ç« '}}</text>
      <text class="swab-categories-subtitle">{{language === 'en' ? 'Choose a category or enter a custom topic below' : 'åœ¨ä¸‹æ–¹é€‰æ‹©åˆ†ç±»æˆ–è¾“å…¥ä¸»é¢˜'}}</text>
    </view>
    <view class="swab-category-list">
      <view
        class="swab-category-chip {{selectedCategory === 'all' || selectedCategory === 'random' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="all"
      >
        {{uiText.categories.all}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'fly tying' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="fly tying"
      >
        {{uiText.categories['fly tying']}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'fly casting' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="fly casting"
      >
        {{uiText.categories['fly casting']}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'biology' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="biology"
      >
        {{uiText.categories.biology}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'gear' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="gear"
      >
        {{uiText.categories.gear}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'conservation' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="conservation"
      >
        {{uiText.categories.conservation}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'orvis' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="orvis"
      >
        {{uiText.categories.orvis}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'winston' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="winston"
      >
        {{uiText.categories.winston}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'sage' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="sage"
      >
        {{uiText.categories.sage}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'redington' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="redington"
      >
        {{uiText.categories.redington}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'rio' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="rio"
      >
        {{uiText.categories.rio}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'scientific anglers' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="scientific anglers"
      >
        {{uiText.categories['scientific anglers']}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'steelhead' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="steelhead"
      >
        {{uiText.categories.steelhead}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'bass' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="bass"
      >
        {{uiText.categories.bass}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'saltwater' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="saltwater"
      >
        {{uiText.categories.saltwater}}
      </view>
      <view
        class="swab-category-chip {{selectedCategory === 'tenkara' ? 'active' : ''}}"
        bindtap="selectCategory"
        data-category="tenkara"
      >
        {{uiText.categories.tenkara}}
      </view>
    </view>
  </view>

  <!-- Custom Input -->
  <view class="swab-input-section" wx:if="{{!loading}}">
    <view class="swab-input-label">
      <text class="input-label-text">{{language === 'en' ? 'ğŸ“ Or Enter Search Topic' : 'ğŸ“ æˆ–è¾“å…¥æœç´¢ä¸»é¢˜'}}</text>
    </view>
    <view class="swab-input-wrapper">
      <input
        class="swab-input"
        placeholder="{{uiText.placeholderCategory}}"
        placeholder-class="swab-input-placeholder"
        bindinput="onCategoryInput"
        value="{{customCategory}}"
        confirm-type="search"
      />
      <view class="swab-input-clear" wx:if="{{customCategory}}" bindtap="clearCustomCategory">âœ•</view>
    </view>
    <text class="swab-input-hint" wx:if="{{customCategory}}">
      {{language === 'en' ? 'ğŸ” Searching for: ' : 'ğŸ” æ­£åœ¨æœç´¢: '}}{{customCategory}}
    </text>
  </view>

  <!-- Bottom Action Bar -->
  <view class="swab-bottom-bar">
    <view class="swab-bar-content">
      <!-- Nav Buttons -->
      <view class="swab-nav-group" wx:if="{{!loading}}">
        <view
          wx:if="{{hasPreviousArticle}}"
          class="swab-nav-btn"
          bindtap="goBackToPrevious"
        >
          â†
        </view>
        <view
          wx:if="{{hasNextArticle}}"
          class="swab-nav-btn"
          bindtap="goBackToNext"
        >
          â†’
        </view>
      </view>

      <!-- Main Action -->
      <block wx:if="{{!loading}}">
        <view class="swab-generate-btn" bindtap="generateCard">
          <text class="generate-text">{{uiText.generateBtn}}</text>
        </view>
      </block>

      <!-- Split Actions -->
      <block wx:if="{{loading}}">
        <view class="swab-cancel-btn" bindtap="cancelGeneration">
          <text class="cancel-text">{{uiText.cancelBtn}}</text>
        </view>
        <view class="swab-searching-btn">
          <text class="searching-text">{{uiText.searching}}</text>
        </view>
      </block>
    </view>
  </view>

  <!-- Floating Tips Card -->
  <view class="swab-tips-card-overlay" wx:if="{{showTipsCard}}" bindtap="closeTipsCard">
    <view
      class="swab-tips-card"
      catchtap="stopPropagation"
      bindtouchstart="handleTouchStart"
      bindtouchmove="handleTouchMove"
      bindtouchend="handleTouchEnd"
      style="transform: translateX({{cardTranslateX}}rpx); opacity: {{cardOpacity}}; transition: transform 0.2s ease, opacity 0.2s ease;"
    >
      <view class="swab-tips-card-header" style="background: {{currentFlashcardCategory.color}}">
        <view class="swab-tips-card-left">
          <text class="swab-tips-card-icon">{{currentFlashcardCategory.icon}}</text>
          <text class="swab-tips-card-category">{{currentFlashcardCategory.label}}</text>
        </view>
        <view class="swab-tips-card-right">
          <text class="swab-tips-card-counter">{{currentTipIndex + 1}} / {{flashcards.length}}</text>
          <view class="swab-tips-card-close" bindtap="closeTipsCard">âœ•</view>
        </view>
      </view>

      <view class="swab-tips-card-content">
        <!-- Question Section -->
        <view class="swab-flashcard-section">
          <view class="swab-flashcard-label">{{uiText.question}}</view>
          <text class="swab-tips-card-text">{{flashcards[currentTipIndex] && (language === 'en' ? (flashcards[currentTipIndex].question.en || flashcards[currentTipIndex].question.zh) : flashcards[currentTipIndex].question.zh)}}</text>
        </view>

        <!-- Answer Button -->
        <view class="swab-answer-btn" bindtap="toggleAnswer">
          <text class="swab-answer-btn-text">{{showAnswer ? uiText.hideAnswer : uiText.showAnswer}}</text>
          <text class="swab-answer-btn-icon">{{showAnswer ? 'â–²' : 'â–¼'}}</text>
        </view>

        <!-- Answer Section (Hidden by default) -->
        <view class="swab-flashcard-answer {{showAnswer ? 'show' : ''}}" wx:if="{{showAnswer}}">
          <view class="swab-flashcard-label">{{uiText.answer}}</view>
          <text class="swab-tips-card-text swab-answer-text">{{flashcards[currentTipIndex] && (language === 'en' ? (flashcards[currentTipIndex].answer.en || flashcards[currentTipIndex].answer.zh) : flashcards[currentTipIndex].answer.zh)}}</text>
        </view>
      </view>

      <view class="swab-tips-hint" style="background: {{currentFlashcardCategory.color}}20">{{language === 'en' ? 'â† Swipe to navigate â†’' : 'â† æ»‘åŠ¨åˆ‡æ¢ â†’'}}</view>
    </view>
  </view>

  <!-- Floating Action Buttons -->
  <view class="floating-actions {{showFloatingButtons ? 'visible' : ''}}">
    <view class="floating-btn" bindtap="toggleLanguage">
      <text class="floating-btn-icon">{{language === 'en' ? 'ğŸŒ' : 'ğŸŒ'}}</text>
    </view>
    <view class="floating-btn" bindtap="goToSettings">
      <text class="floating-btn-icon">âš™ï¸</text>
    </view>
  </view>
</view>
